{% extends "base.html" %}

{% block title %}Supercharged Marketplace Search{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --accent-color: #ffa000;
        --danger-color: #d32f2f;
        --success-color: #4caf50;
        
        --bg-primary: #f8f9fa;
        --bg-secondary: #ffffff;
        --text-primary: #343a40;
        --text-secondary: #6c757d;
        --border-color: #e9ecef;
        --shadow-color: rgba(0, 0, 0, 0.1);
    }

    /* Dark Mode Variables */
    body.dark-mode {
        --bg-primary: #121212;
        --bg-secondary: #1e1e1e;
        --text-primary: #e0e0e0;
        --text-secondary: #a0a0a0;
        --border-color: #333333;
        --shadow-color: rgba(255, 255, 255, 0.08);
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s, color 0.3s;
    }

    /* --- General Layout --- */
    .marketplace-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    .marketplace-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 40px 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
    }
    .marketplace-header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
    }
    
    /* --- Search & Filters --- */
    .search-section {
        background: var(--bg-secondary);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 20px var(--shadow-color);
        margin-bottom: 30px;
    }
    .search-box {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    .search-input {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 16px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: border-color 0.3s;
    }
    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    .btn {
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s, opacity 0.2s;
        border: none;
        text-decoration: none;
    }
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
    }
    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    .btn-secondary {
        background: var(--border-color);
        color: var(--text-primary);
    }
    .btn-icon {
        background: none;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 8px;
        width: 40px;
        height: 40px;
        line-height: 40px;
        padding: 0;
        transition: all 0.2s;
    }
    .btn-icon:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    .btn-icon.active {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }

    /* Filter Bar */
    .filters-bar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
    }
    .marketplace-tab, .sort-dropdown, #darkModeBtn {
        padding: 8px 15px;
        border: 2px solid var(--border-color);
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .marketplace-tab.active, .marketplace-tab:hover, .sort-dropdown:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    #sortBy {
        appearance: none;
        padding-right: 30px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23667eea'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px top 50%;
        background-size: 18px;
    }
    #darkModeBtn {
        margin-left: auto; /* Push dark mode button to the right */
    }
    
    /* Results Info */
    #resultsInfo {
        padding: 10px 0;
        font-size: 1.1em;
        font-weight: 600;
        color: var(--text-primary);
    }

    /* --- Product Grid & Card --- */
    #productsGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
        min-height: 200px;
    }
    .product-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
    }
    .product-card:hover {
        box-shadow: 0 8px 25px var(--shadow-color);
        transform: translateY(-5px);
    }
    .product-image {
        width: 100%;
        height: 200px;
        overflow: hidden;
        position: relative;
    }
    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .product-marketplace {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 600;
    }
    .product-info {
        padding: 15px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .product-title {
        font-size: 1.1em;
        font-weight: bold;
        margin-bottom: 8px;
        height: 3em; /* Restrict title to 2 lines */
        overflow: hidden;
    }
    .product-price {
        margin-bottom: 10px;
        font-size: 1.4em;
        font-weight: bold;
        color: var(--danger-color);
    }
    .product-price .shipping {
        display: block;
        font-size: 0.6em;
        font-weight: normal;
        color: var(--text-secondary);
        margin-top: 2px;
    }
    .product-price .shipping.free {
        color: var(--success-color);
    }
    .product-rating {
        font-size: 0.9em;
        color: var(--text-secondary);
        margin-bottom: 10px;
    }
    .product-rating span:first-child {
        color: var(--accent-color);
    }
    .out-of-stock {
        color: var(--danger-color);
        font-weight: bold;
        font-size: 0.9em;
        margin-bottom: 10px;
    }
    .product-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    .product-actions .btn-sm {
        padding: 8px 15px;
        font-size: 14px;
        flex-grow: 1;
    }

    /* --- Loading/Error States --- */
    .skeleton-loader {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        grid-column: 1/-1;
    }
    .product-skeleton {
        height: 350px;
        background-color: var(--border-color);
        border-radius: 12px;
        animation: pulse 1.5s infinite ease-in-out;
    }
    body.dark-mode .product-skeleton {
        background-color: #333333;
    }
    @keyframes pulse {
        0% { opacity: 0.5; }
        50% { opacity: 1; }
        100% { opacity: 0.5; }
    }

    /* --- Modals --- */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal.hidden {
        display: none;
    }
    .modal-content {
        background: var(--bg-secondary);
        padding: 30px;
        border-radius: 15px;
        max-width: 90%;
        width: 500px;
        box-shadow: 0 10px 30px var(--shadow-color);
        position: relative;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
    }
    .modal-header h2 {
        margin: 0;
    }
    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: var(--text-primary);
    }
    .form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 16px;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    /* Price Alert Specific */
    .alert-product {
        display: flex;
        align-items: center;
        background: var(--bg-primary);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .alert-product img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 15px;
    }
    .alert-product h4 {
        margin: 0 0 5px 0;
        font-size: 1em;
    }
    #currentPriceText {
        display: block;
        margin-top: 5px;
        font-size: 0.9em;
        color: var(--text-secondary);
    }
    
    /* Comparison Modal */
    .comparison-modal {
        max-width: 1200px;
        width: 95%;
    }
    .comparison-table-wrapper {
        overflow-x: auto;
    }
    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        min-width: 800px;
    }
    .comparison-table th, .comparison-table td {
        border: 1px solid var(--border-color);
        padding: 12px;
        text-align: center;
    }
    .comparison-table th {
        background: var(--bg-primary);
        font-weight: 700;
        color: var(--primary-color);
    }
    .comparison-table td:first-child {
        text-align: left;
        background: var(--bg-primary);
        font-weight: 600;
        white-space: nowrap;
    }
    .price-cell {
        color: var(--danger-color);
        font-weight: bold;
        font-size: 1.1em;
    }
    .best-value-banner {
        padding: 15px;
        background: #e6ffed; /* Light green */
        border: 1px solid var(--success-color);
        border-radius: 8px;
        color: #1a5e20;
        display: flex;
        align-items: center;
        gap: 15px;
        font-weight: 500;
    }
    
    /* --- Comparison Sidebar Panel --- */
    .comparison-panel {
        position: fixed;
        top: 0;
        right: 0;
        width: 350px;
        height: 100%;
        background: var(--bg-secondary);
        box-shadow: -5px 0 15px var(--shadow-color);
        z-index: 1500;
        transform: translateX(100%);
        transition: transform 0.3s ease-out;
        display: flex;
        flex-direction: column;
    }
    .comparison-panel.hidden {
        transform: translateX(100%);
    }
    .comparison-panel:not(.hidden) {
        transform: translateX(0);
    }
    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
    }
    .panel-header h3 {
        margin: 0;
        font-size: 1.2em;
    }
    #compareItems {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
    }
    .panel-footer {
        padding: 20px;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 10px;
    }
    .panel-footer .btn {
        flex: 1;
        padding: 12px 15px;
        font-size: 14px;
    }
    .compare-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px dashed var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="marketplace-container">
    <div class="marketplace-header">
        <h1>üõí Marketplace Search</h1>
        <p>Search across Amazon, eBay, Walmart, and more with advanced comparison</p>
    </div>

    <div class="search-section">
        <form id="marketplaceSearchForm" autocorrect="on" autocomplete="on" >
            <div class="search-box">
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="What are you shopping for?"
                       name="q"
                       autofocus>
                <button type="submit" class="btn btn-primary" id="searchBtn">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </form>

        <div class="filters-bar">
            <button class="marketplace-tab" id="darkModeBtn" title="Toggle Dark Mode">
                <i class="fas fa-moon"></i>
            </button>
            
            <button class="marketplace-tab active" data-marketplace="all">
                All Stores
            </button>
            <button class="marketplace-tab" data-marketplace="amazon">
                <i class="fab fa-amazon"></i> Amazon
            </button>
            <button class="marketplace-tab" data-marketplace="ebay">
                <i class="fas fa-gavel"></i> eBay
            </button>
            <button class="marketplace-tab" data-marketplace="walmart">
                <i class="fas fa-store"></i> Walmart
            </button>
            
            <select class="sort-dropdown" id="sortBy">
                <option value="relevance">Best Match</option>
                <option value="price_asc">Price: Low to High</option>
                <option value="price_desc">Price: High to Low</option>
                <option value="rating">Highest Rated</option>
            </select>

            <button class="marketplace-tab" id="priceFilterBtn">
                üí∞ Price Range
            </button>
            
            <button class="marketplace-tab" id="compareBtn">
                ‚öñÔ∏è Compare (<span id="compareCount">0</span>)
            </button>
        </div>

        <div id="resultsInfo">Ready to search</div>

        <div id="productsGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: var(--text-secondary);">
                <i class="fas fa-shopping-bag" style="font-size: 60px; margin-bottom: 20px;"></i>
                <h3>Start your search</h3>
                <p>Enter a product name above to begin comparing prices.</p>
            </div>
        </div>
    </div>
</div>

<div id="priceFilterModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üí∞ Set Price Range</h2>
            <button class="close-btn" id="closePriceFilter">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Minimum Price</label>
                <input type="number" class="form-input" id="minPrice" placeholder="e.g. 50.00" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Maximum Price</label>
                <input type="number" class="form-input" id="maxPrice" placeholder="e.g. 500.00" min="0" step="0.01">
            </div>
            <button class="btn btn-primary" id="applyPriceFilter" style="width: 100%;">
                <i class="fas fa-filter"></i> Apply Filters
            </button>
        </div>
    </div>
</div>

<div id="priceAlertModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üîî Set Price Alert</h2>
            <button class="close-btn" id="closeAlertModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="alertProductInfo"></div>
            
            <div class="form-group">
                <label>Your Email</label>
                <input type="email" class="form-input" id="alertEmail" placeholder="your@email.com" required>
            </div>
            
            <div class="form-group">
                <label>Target Price (Alert me when price drops below...)</label>
                <input type="number" class="form-input" id="targetPrice" placeholder="e.g. 99.99" step="0.01" min="0" required>
                <small id="currentPriceText">Current price: $0.00</small>
            </div>
            
            <button class="btn btn-primary" id="createAlertBtn" style="width: 100%;">
                <i class="fas fa-bell"></i> Create Alert
            </button>
        </div>
    </div>
</div>

<div id="comparisonPanel" class="comparison-panel hidden">
    <div class="panel-header">
        <h3>Compare Products (<span id="compareCountText">0</span>)</h3>
        <button class="close-btn" id="closeComparePanel">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="compareItems">
        </div>
    <div class="panel-footer">
        <button class="btn btn-primary" id="viewComparisonBtn" disabled>
            <i class="fas fa-balance-scale"></i> View Comparison
        </button>
        <button class="btn btn-secondary" id="clearCompareBtn">
            Clear All
        </button>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    /**
     * Placeholder Utility Functions (Required by your provided JS)
     */
    const Utils = {
        // Simple loading indicator toggle (can be enhanced)
        showLoading: function() {
            document.body.style.cursor = 'wait';
        },
        hideLoading: function() {
            document.body.style.cursor = 'default';
        },
        // Simple Toast Notification (basic implementation)
        showToast: function(message, type = 'info', duration = 3000) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // In a real app, this would show a small non-blocking notification
        },
        // Get query parameter from URL
        getQueryParam: function(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        },
        // Set query parameter (updates URL without full reload)
        setQueryParam: function(key, value) {
            const url = new URL(window.location);
            if (value) {
                url.searchParams.set(key, value);
            } else {
                url.searchParams.delete(key);
            }
            window.history.pushState({}, '', url);
        },
        // Simple email validation
        isValidEmail: function(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }
    };

    /**
     * Marketplace Page Logic (Your Provided Code)
     */

    let currentQuery = '';
    let currentMarketplace = 'all';
    let currentSort = 'relevance';
    let priceFilters = { min: null, max: null };
    let compareList = [];
    let allProducts = [];
    let selectedProduct = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Get query from URL parameter
        currentQuery = Utils.getQueryParam('q') || '';
        if (currentQuery) {
            document.getElementById('searchInput').value = currentQuery;
            performMarketplaceSearch();
        }
        
        setupEventListeners();
        
        // Check for saved dark mode preference
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            const icon = document.querySelector('#darkModeBtn i');
            if (icon) {
                icon.classList.replace('fa-moon', 'fa-sun');
            }
        }
        
        // Initial comparison panel setup
        updateComparePanel();
    });

    function setupEventListeners() {
        // Search form submission
        const searchForm = document.getElementById('marketplaceSearchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                currentQuery = document.getElementById('searchInput').value.trim();
                if (currentQuery) {
                    Utils.setQueryParam('q', currentQuery);
                    performMarketplaceSearch();
                }
            });
        }
        
        // Marketplace tabs
        document.querySelectorAll('.marketplace-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Ignore the dark mode button
                if (tab.id === 'darkModeBtn' || tab.id === 'priceFilterBtn' || tab.id === 'compareBtn') return;
                
                // Update active tab
                document.querySelectorAll('.marketplace-tab').forEach(t => {
                    if (t.dataset.marketplace) {
                        t.classList.remove('active');
                    }
                });
                tab.classList.add('active');
                
                currentMarketplace = tab.dataset.marketplace;
                performMarketplaceSearch();
            });
        });
        
        // Sort dropdown
        const sortBy = document.getElementById('sortBy');
        if (sortBy) {
            sortBy.addEventListener('change', (e) => {
                currentSort = e.target.value;
                performMarketplaceSearch();
            });
        }
        
        // Price filter button and modal
        const priceFilterBtn = document.getElementById('priceFilterBtn');
        const priceFilterModal = document.getElementById('priceFilterModal');
        const closePriceFilter = document.getElementById('closePriceFilter');
        const applyPriceFilter = document.getElementById('applyPriceFilter');
        
        if (priceFilterBtn) {
            priceFilterBtn.addEventListener('click', () => {
                priceFilterModal.classList.remove('hidden');
            });
        }
        
        if (closePriceFilter) {
            closePriceFilter.addEventListener('click', () => {
                priceFilterModal.classList.add('hidden');
            });
        }
        
        if (applyPriceFilter) {
            applyPriceFilter.addEventListener('click', () => {
                priceFilters.min = parseFloat(document.getElementById('minPrice').value) || null;
                priceFilters.max = parseFloat(document.getElementById('maxPrice').value) || null;
                priceFilterModal.classList.add('hidden');
                performMarketplaceSearch();
            });
        }
        
        // Compare panel controls
        const compareBtn = document.getElementById('compareBtn');
        const comparisonPanel = document.getElementById('comparisonPanel');
        const closeComparePanel = document.getElementById('closeComparePanel');
        const clearCompareBtn = document.getElementById('clearCompareBtn');
        const viewComparisonBtn = document.getElementById('viewComparisonBtn');
        
        if (compareBtn) {
            compareBtn.addEventListener('click', () => {
                comparisonPanel.classList.toggle('hidden');
                if (!comparisonPanel.classList.contains('hidden')) {
                    updateComparePanel(); // Refresh list when opening
                }
            });
        }
        
        if (closeComparePanel) {
            closeComparePanel.addEventListener('click', () => {
                comparisonPanel.classList.add('hidden');
            });
        }
        
        if (clearCompareBtn) {
            clearCompareBtn.addEventListener('click', () => {
                clearCompareList();
            });
        }
        
        if (viewComparisonBtn) {
            viewComparisonBtn.addEventListener('click', () => {
                viewComparison();
            });
        }
        
        // Alert modal controls
        const closeAlertModal = document.getElementById('closeAlertModal');
        const createAlertBtn = document.getElementById('createAlertBtn');
        
        if (closeAlertModal) {
            closeAlertModal.addEventListener('click', () => {
                document.getElementById('priceAlertModal').classList.add('hidden');
            });
        }
        
        if (createAlertBtn) {
            createAlertBtn.addEventListener('click', () => {
                createPriceAlert();
            });
        }
        
        // Dark mode toggle
        const darkModeBtn = document.getElementById('darkModeBtn');
        if (darkModeBtn) {
            darkModeBtn.addEventListener('click', toggleDarkMode);
        }
        
        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        });
    }

    async function performMarketplaceSearch() {
        if (!currentQuery) {
            Utils.showToast('Please enter a search query', 'warning');
            return;
        }
        
        // Show loading state
        showLoading();
        
        try {
            // Build search parameters
            const params = {
                q: currentQuery,
                max_results: 30,
                sort_by: currentSort
            };
            
            // Add marketplace filter
            if (currentMarketplace !== 'all') {
                params.marketplaces = currentMarketplace;
            }
            
            // Add price range
            if (priceFilters.min) params.min_price = priceFilters.min;
            if (priceFilters.max) params.max_price = priceFilters.max;
            
            // Perform search using POST
            // NOTE: The endpoint '/api/marketplace/search' is assumed to exist and return JSON.
            const response = await fetch('/api/marketplace/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            
            const data = await response.json();
            
            // Assuming data structure { status: 'success', data: { products: [] } }
            if (data.status === 'success') {
                // Assign unique IDs if missing (required for comparison tracking)
                const products = (data.data.products || data.data.results || []).map((p, index) => {
                    p.id = p.id || `${p.url}-${p.marketplace}-${index}`;
                    return p;
                });
                
                allProducts = products;
                displayProducts(allProducts);
            } else {
                throw new Error(data.error || 'Search failed');
            }
            
        } catch (error) {
            console.error('Marketplace search error:', error);
            showError(error.message);
            Utils.showToast('Search failed: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function showLoading() {
        const resultsInfo = document.getElementById('resultsInfo');
        const productsGrid = document.getElementById('productsGrid');
        
        if (resultsInfo) {
            resultsInfo.innerHTML = '<span><i class="fas fa-spinner fa-spin"></i> Searching...</span>';
        }
        
        if (productsGrid) {
            productsGrid.innerHTML = '<div class="skeleton-loader">' +
                '<div class="product-skeleton"></div>'.repeat(8) + // Show 8 placeholders
                '</div>';
        }
    }

    function hideLoading() {
        // Loading state is replaced by results, nothing extra needed here.
    }

    function displayProducts(products) {
        const grid = document.getElementById('productsGrid');
        const resultsInfo = document.getElementById('resultsInfo');
        
        if (!products || products.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px;">' +
                '<i class="fas fa-shopping-bag" style="font-size: 60px; color: var(--text-secondary); margin-bottom: 20px;"></i>' +
                '<h3>No products found</h3>' +
                '<p style="color: var(--text-secondary);">Try different keywords or filters</p>' +
                '</div>';
            resultsInfo.innerHTML = '<span>0 products found</span>';
            return;
        }
        
        // Update results info
        const count = products.length;
        resultsInfo.innerHTML = '<span>Found <strong>' + count + '</strong> product' + 
            (count !== 1 ? 's' : '') + ' for "' + escapeHtml(currentQuery) + '"</span>';
        
        // Render products
        grid.innerHTML = '';
        products.forEach(product => {
            const card = createProductCard(product);
            grid.appendChild(card);
        });
        
        updateComparePanel(); // Ensure header count is correct
    }

    function createProductCard(product) {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.dataset.productId = product.id;
        
        const isCompared = compareList.some(p => p.id === product.id);
        const marketplaceIcon = getMarketplaceIcon(product.marketplace);
        const price = product.price || 0;
        const rating = product.rating || 0;
        const reviews = product.reviews || 0;
        const isOutOfStock = product.in_stock === false || 
                            (product.availability && product.availability.toLowerCase().includes('out of stock'));
        
        // Build star rating
        const starCount = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        const emptyStarCount = 5 - starCount - (hasHalfStar ? 1 : 0);
        
        let stars = '';
        for (let i = 0; i < starCount; i++) stars += '‚òÖ';
        if (hasHalfStar) stars += '¬Ω';
        for (let i = 0; i < emptyStarCount; i++) stars += '‚òÜ';
        
        // Build product image
        let imageHtml = '';
        if (product.image_url || product.image) {
            imageHtml = '<img src="' + escapeHtml(product.image_url || product.image) + 
                       '" alt="' + escapeHtml(product.title) + 
                       '" loading="lazy" onerror="this.src=\'\'">'; // Using empty string to stop broken image icon
        } else {
            imageHtml = '<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background: var(--bg-secondary); border-radius: 8px;">' +
                       '<i class="fas fa-image" style="font-size: 48px; color: var(--text-secondary);"></i>' +
                       '</div>';
        }
        
        // Build shipping info
        let shippingHtml = '';
        if (product.shipping_cost && product.shipping_cost > 0) {
            shippingHtml = '<span class="shipping">+$' + parseFloat(product.shipping_cost).toFixed(2) + ' shipping</span>';
        } else if (product.shipping && product.shipping.toLowerCase() === 'free') {
            shippingHtml = '<span class="shipping free">Free shipping</span>';
        } else if (product.shipping) {
            shippingHtml = '<span class="shipping">' + escapeHtml(product.shipping) + '</span>';
        }
        
        // Build rating HTML
        let ratingHtml = '';
        if (rating > 0) {
            ratingHtml = '<div class="product-rating">' +
                '<span style="color: var(--accent-color); font-size: 1.1em;">' + stars + '</span>' +
                '<span style="margin-left: 5px;">' + rating.toFixed(1) + '</span>';
            if (reviews > 0) {
                ratingHtml += '<span style="margin-left: 5px;">(' + reviews + ')</span>';
            }
            ratingHtml += '</div>';
        }
        
        card.innerHTML = '<div class="product-image">' +
            imageHtml +
            '<span class="product-marketplace">' + marketplaceIcon + '</span>' +
            '</div>' +
            '<div class="product-info">' +
            '<h3 class="product-title">' + escapeHtml(product.title || product.name || 'Product') + '</h3>' +
            '<div class="product-price">' +
            '<span class="price">' + formatPrice(price, product.currency) + '</span>' +
            shippingHtml +
            '</div>' +
            ratingHtml +
            (isOutOfStock ? '<span class="out-of-stock">Out of Stock</span>' : '') +
            '<div class="product-actions">' +
            '<button class="btn btn-primary btn-sm" onclick="window.open(\'' + product.url + '\', \'_blank\')" ' +
            (isOutOfStock ? 'disabled' : '') + '>' +
            '<i class="fas fa-external-link-alt"></i> View Deal' +
            '</button>' +
            '<button class="btn-icon ' + (isCompared ? 'active' : '') + '" ' +
            'onclick="addToCompare(\'' + product.id + '\')" title="Add to comparison" ' +
            (compareList.length >= 4 && !isCompared ? 'disabled' : '') + '>' +
            '<i class="fas fa-balance-scale"></i>' +
            '</button>' +
            '<button class="btn-icon" onclick="showPriceAlert(\'' + product.id + '\')" title="Set price alert">' +
            '<i class="fas fa-bell"></i>' +
            '</button>' +
            '</div>' +
            '</div>';
        
        return card;
    }

    function formatPrice(price, currency) {
        if (!price || isNaN(price)) return 'N/A';
        currency = currency || 'USD';
        const symbol = currency === 'USD' ? '$' : currency;
        return symbol + parseFloat(price).toFixed(2);
    }

    function getMarketplaceIcon(marketplace) {
        const icons = {
            'amazon': '<i class="fab fa-amazon"></i> Amazon',
            'ebay': '<i class="fas fa-gavel"></i> eBay',
            'walmart': '<i class="fas fa-store"></i> Walmart'
        };
        const lowerMarketplace = (marketplace || '').toLowerCase();
        return icons[lowerMarketplace] || escapeHtml(marketplace || 'Store');
    }

    function addToCompare(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) {
            console.error('Product not found:', productId);
            return;
        }
        
        // Check if already in compare list
        const index = compareList.findIndex(p => p.id === productId);
        
        if (index > -1) {
            // Remove from comparison
            compareList.splice(index, 1);
            Utils.showToast('Removed from comparison', 'info');
        } else {
            // Add to comparison (max 4)
            if (compareList.length >= 4) {
                Utils.showToast('Maximum 4 products for comparison', 'warning');
                return;
            }
            compareList.push(product);
            Utils.showToast('Added to comparison', 'success');
        }
        
        updateComparePanel();
        displayProducts(allProducts); // Re-render to update button states
    }

    function removeFromCompare(productId) {
        compareList = compareList.filter(p => p.id !== productId);
        updateComparePanel();
        displayProducts(allProducts);
        Utils.showToast('Removed from comparison', 'info');
    }

    function updateComparePanel() {
        const count = compareList.length;
        const compareCount = document.getElementById('compareCount'); // Main button count
        const compareCountText = document.getElementById('compareCountText'); // Sidebar header count
        const compareItems = document.getElementById('compareItems');
        const viewComparisonBtn = document.getElementById('viewComparisonBtn');
        
        if (compareCount) compareCount.textContent = count;
        if (compareCountText) compareCountText.textContent = count;
        
        // Update compare items list
        if (compareItems) {
            compareItems.innerHTML = '';
            if (count === 0) {
                compareItems.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No items added to compare.</p>';
            } else {
                compareList.forEach(product => {
                    const div = document.createElement('div');
                    div.className = 'compare-item';
                    
                    const title = product.title.substring(0, 40);
                    const displayTitle = product.title.length > 40 ? title + '...' : title;
                    
                    div.innerHTML = '<div>' +
                        '<div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">' +
                        escapeHtml(displayTitle) +
                        '</div>' +
                        '<div style="color: var(--danger-color); font-weight: 700;">' +
                        formatPrice(product.price, product.currency) +
                        '</div>' +
                        '</div>' +
                        '<button class="btn-icon" onclick="removeFromCompare(\'' + product.id + '\')" title="Remove">' +
                        '<i class="fas fa-times"></i>' +
                        '</button>';
                    
                    compareItems.appendChild(div);
                });
            }
        }
        
        // Enable/disable comparison button
        if (viewComparisonBtn) {
            viewComparisonBtn.disabled = count < 2;
        }
    }

    function clearCompareList() {
        compareList = [];
        updateComparePanel();
        displayProducts(allProducts);
        Utils.showToast('Comparison list cleared', 'info');
    }

    function viewComparison() {
        if (compareList.length < 2) {
            Utils.showToast('Select at least 2 products to compare', 'warning');
            return;
        }
        
        // Close sidebar
        document.getElementById('comparisonPanel').classList.add('hidden');
        
        displayComparison({ products: compareList });
    }

    function displayComparison(comparisonData) {
        const products = comparisonData.products || [];
        
        // Clean up any existing modal
        const existingModal = document.getElementById('comparisonModal');
        if (existingModal) existingModal.remove();

        // Find best value (lowest price)
        const validPrices = products.map(p => p.price).filter(p => !isNaN(p) && p > 0);
        const lowestPrice = Math.min.apply(null, validPrices);
        const bestValue = products.find(p => p.price === lowestPrice);
        
        // Create comparison modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'comparisonModal';
        modal.style.display = 'flex';
        
        // Build table headers (product images)
        let headerCells = '';
        products.forEach((p, i) => {
            const isBest = bestValue && bestValue.id === p.id;
            let imageHtml = '';
            if (p.image_url || p.image) {
                imageHtml = '<img src="' + escapeHtml(p.image_url || p.image) + '" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">';
            }
            headerCells += '<th>' + 
                (isBest ? '<i class="fas fa-trophy" style="color: ' + varColor('--accent-color') + ';"></i><br>' : '') +
                imageHtml +
                'Product ' + (i + 1) + 
                '</th>';
        });
        
        // Build table rows
        function buildRow(label, mapper) {
            let cells = '';
            products.forEach(p => {
                cells += '<td>' + mapper(p) + '</td>';
            });
            return '<tr><td><strong>' + label + '</strong></td>' + cells + '</tr>';
        }
        
        const titleRow = buildRow('Title', p => escapeHtml(p.title || 'N/A'));
        const priceRow = buildRow('Price', p => '<span class="price-cell">' + formatPrice(p.price, p.currency) + '</span>');
        const marketplaceRow = buildRow('Marketplace', p => getMarketplaceIcon(p.marketplace));
        
        const ratingRow = buildRow('Rating', p => {
            if (!p.rating) return 'N/A';
            const stars = Math.round(p.rating);
            let starStr = '';
            for (let i = 0; i < stars; i++) starStr += '‚òÖ';
            return p.rating.toFixed(1) + ' ' + starStr;
        });
        
        const reviewsRow = buildRow('Reviews', p => p.reviews || 'N/A');
        const shippingRow = buildRow('Shipping', p => escapeHtml(p.shipping || 'N/A'));
        const availRow = buildRow('Availability', p => p.in_stock !== false ? '<span style="color: var(--success-color); font-weight: bold;">‚úì In Stock</span>' : '<span style="color: var(--danger-color); font-weight: bold;">‚úó Out of Stock</span>');
        
        const actionRow = '<tr><td></td>' + products.map(p => 
            '<td><a href="' + p.url + '" target="_blank" class="btn btn-primary btn-sm" style="padding: 8px 15px;">View Deal</a></td>'
        ).join('') + '</tr>';
        
        // Best value banner
        let bannerHtml = '';
        if (bestValue) {
            const shortTitle = bestValue.title.substring(0, 50);
            const displayTitle = bestValue.title.length > 50 ? shortTitle + '...' : shortTitle;
            bannerHtml = '<div class="best-value-banner">' +
                '<i class="fas fa-trophy" style="font-size: 24px;"></i>' +
                '<div>' +
                '<div><strong>Best Value Found:</strong> ' + escapeHtml(displayTitle) + '</div>' +
                '<div>Price: <span style="font-size: 1.2em;">' + formatPrice(bestValue.price, bestValue.currency) + '</span></div>' +
                '</div>' +
                '</div>';
        }
        
        modal.innerHTML = '<div class="modal-content comparison-modal">' +
            '<div class="modal-header">' +
            '<h2><i class="fas fa-balance-scale"></i> Product Comparison</h2>' +
            '<button class="close-btn" onclick="document.getElementById(\'comparisonModal\').remove()">' +
            '<i class="fas fa-times"></i>' +
            '</button>' +
            '</div>' +
            '<div class="modal-body">' +
            bannerHtml +
            '<div class="comparison-table-wrapper" style="margin-top: 20px;">' +
            '<table class="comparison-table">' +
            '<thead><tr><th>Feature</th>' + headerCells + '</tr></thead>' +
            '<tbody>' +
            titleRow + priceRow + marketplaceRow + ratingRow + reviewsRow + shippingRow + availRow + actionRow +
            '</tbody>' +
            '</table>' +
            '</div>' +
            '</div>' +
            '</div>';
        
        document.body.appendChild(modal);
        
        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function showPriceAlert(productId) {
        selectedProduct = allProducts.find(p => p.id === productId);
        
        if (!selectedProduct) {
            console.error('Product not found for alert:', productId);
            Utils.showToast('Product not found', 'error');
            return;
        }
        
        const modal = document.getElementById('priceAlertModal');
        const productInfo = document.getElementById('alertProductInfo');
        const currentPriceText = document.getElementById('currentPriceText');
        
        let imageHtml = '';
        if (selectedProduct.image_url || selectedProduct.image) {
            imageHtml = '<img src="' + escapeHtml(selectedProduct.image_url || selectedProduct.image) + 
                       '" alt="' + escapeHtml(selectedProduct.title) + '">';
        } else {
            imageHtml = '<div style="width:80px;height:80px;background:var(--bg-secondary);border-radius:8px;"></div>';
        }
        
        productInfo.innerHTML = '<div class="alert-product">' +
            imageHtml +
            '<div>' +
            '<h4>' + escapeHtml(selectedProduct.title.substring(0, 50)) + (selectedProduct.title.length > 50 ? '...' : '') + '</h4>' +
            '<p style="font-size: 0.9em; color: var(--text-secondary); margin: 0;">' + getMarketplaceIcon(selectedProduct.marketplace) + '</p>' +
            '</div>' +
            '</div>';
        
        currentPriceText.textContent = 'Current price: ' + formatPrice(selectedProduct.price, selectedProduct.currency);
        document.getElementById('targetPrice').value = '';
        // Pre-fill email if user data is available (not implemented here)
        // document.getElementById('alertEmail').value = ''; 
        
        modal.classList.remove('hidden');
    }

    async function createPriceAlert() {
        const email = document.getElementById('alertEmail').value.trim();
        const targetPrice = parseFloat(document.getElementById('targetPrice').value);
        
        if (!selectedProduct) return;
        
        if (!email || !Utils.isValidEmail(email)) {
            Utils.showToast('Please enter a valid email', 'error');
            return;
        }
        
        if (isNaN(targetPrice) || targetPrice <= 0) {
            Utils.showToast('Please enter a valid target price', 'error');
            return;
        }
        
        if (selectedProduct.price && targetPrice >= selectedProduct.price) {
            const confirmResult = confirm('Target price is higher than or equal to the current price. Do you still want to create this alert?');
            if (!confirmResult) return;
        }
        
        Utils.showLoading();
        
        try {
            // NOTE: The endpoint '/api/alerts' is assumed to exist and accept JSON.
            const response = await fetch('/api/alerts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email,
                    product_name: selectedProduct.title,
                    product_url: selectedProduct.url,
                    marketplace: selectedProduct.marketplace,
                    target_price: targetPrice,
                    current_price: selectedProduct.price || 0
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                Utils.showToast('‚úì Price alert created! You will receive an email when the price drops.', 'success', 5000);
                document.getElementById('priceAlertModal').classList.add('hidden');
                document.getElementById('targetPrice').value = '';
            } else {
                Utils.showToast('Failed to create alert: ' + data.error, 'error');
            }
            
        } catch (error) {
            console.error('Alert creation error:', error);
            Utils.showToast('Failed to create alert: ' + error.message, 'error');
        } finally {
            Utils.hideLoading();
        }
    }

    function showError(message) {
        const resultsInfo = document.getElementById('resultsInfo');
        const productsGrid = document.getElementById('productsGrid');
        
        if (resultsInfo) {
            resultsInfo.innerHTML = '<span style="color: var(--danger-color);"><i class="fas fa-exclamation-triangle"></i> Search failed</span>';
        }
        
        if (productsGrid) {
            productsGrid.innerHTML = '<div style="grid-column: 1/-1; padding: 40px; text-align: center;">' +
                '<div class="error">' +
                '<strong>Error:</strong> ' + escapeHtml(message) +
                '</div>' +
                '<p style="margin-top: 20px; color: var(--text-secondary);">' +
                'Please try again or contact support if the problem persists.' +
                '</p>' +
                '</div>';
        }
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const icon = document.querySelector('#darkModeBtn i');
        
        if (document.body.classList.contains('dark-mode')) {
            icon.classList.replace('fa-moon', 'fa-sun');
            localStorage.setItem('darkMode', 'enabled');
        } else {
            icon.classList.replace('fa-sun', 'fa-moon');
            localStorage.setItem('darkMode', 'disabled');
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function varColor(variable) {
        return getComputedStyle(document.documentElement).getPropertyValue(variable).trim();
    }

    // Make functions globally accessible
    window.addToCompare = addToCompare;
    window.removeFromCompare = removeFromCompare;
    window.showPriceAlert = showPriceAlert;
</script>
{% endblock %}